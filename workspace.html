<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workspace - Incoming Links</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --storm: #0A181C; --monday: #79E2FF; --day: #C7F8BA; --suede: #00A5D3; --electro: #221327; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--storm); min-height: 100vh; color: white; }
    .container { max-width: 1800px; margin: 0 auto; padding: 20px; }

    .nav { display: flex; gap: 12px; margin-bottom: 24px; }
    .nav a { padding: 12px 24px; background: rgba(255,255,255,0.1); border-radius: 8px; color: white; text-decoration: none; font-weight: 600; font-size: 14px; transition: all 0.2s; }
    .nav a:hover { background: rgba(255,255,255,0.2); }
    .nav a.active { background: var(--monday); color: var(--storm); }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px; }
    .header h1 { font-size: 28px; font-weight: 800; color: var(--monday); }
    .header-right { display: flex; align-items: center; gap: 16px; }
    .live { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--day); }
    .live-dot { width: 8px; height: 8px; background: var(--day); border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    .btn { padding: 10px 18px; background: var(--suede); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s; }
    .btn:hover { background: var(--monday); color: var(--storm); }
    .btn-small { padding: 6px 10px; font-size: 11px; }
    .btn-done { background: var(--day); color: var(--storm); min-width: 32px; }
    .btn-done.active { background: #22c55e; }
    .btn-flag { background: transparent; border: 1px solid var(--monday); color: var(--monday); }
    .btn-flag:hover { background: var(--monday); color: var(--storm); }

    .filters { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-label { font-size: 10px; color: rgba(255,255,255,0.5); text-transform: uppercase; font-weight: 600; }
    select, input[type="date"] { padding: 8px 12px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: white; font-size: 13px; font-family: 'Inter', sans-serif; }
    select:focus, input:focus { outline: none; border-color: var(--monday); }
    option { background: var(--storm); }

    .quick-btns { display: flex; gap: 6px; flex-wrap: wrap; }
    .quick-btn { padding: 8px 14px; background: rgba(255,255,255,0.08); border: none; border-radius: 20px; font-size: 12px; color: white; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s; }
    .quick-btn:hover, .quick-btn.active { background: var(--monday); color: var(--storm); }

    .table-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 13px; color: rgba(255,255,255,0.6); }

    .table-wrapper { overflow-x: auto; background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); }
    table { width: 100%; border-collapse: collapse; }
    thead { background: rgba(0,0,0,0.4); position: sticky; top: 0; }
    th { padding: 14px 12px; text-align: left; font-size: 10px; font-weight: 700; color: var(--monday); text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; border-bottom: 2px solid var(--monday); }
    td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 12px; color: rgba(255,255,255,0.85); vertical-align: top; }
    tr:hover { background: rgba(121,226,255,0.03); }
    tr.done-row { opacity: 0.5; }

    .domain-cell { font-weight: 700; color: var(--monday); font-size: 13px; }
    .url-link { color: var(--monday); text-decoration: none; font-size: 11px; word-break: break-all; }
    .url-link:hover { color: var(--day); text-decoration: underline; }

    .draft-link { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; background: rgba(199,248,186,0.15); border-radius: 6px; color: var(--day); text-decoration: none; font-size: 12px; font-weight: 600; transition: all 0.2s; margin: 2px 0; }
    .draft-link:hover { background: var(--day); color: var(--storm); }
    .draft-link.ar { background: rgba(121,226,255,0.15); color: var(--monday); }
    .draft-link.ar:hover { background: var(--monday); color: var(--storm); }
    .no-draft { color: rgba(255,255,255,0.3); font-size: 11px; }

    .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; }
    .badge.high { background: rgba(199,248,186,0.2); color: var(--day); }
    .badge.medium { background: rgba(121,226,255,0.2); color: var(--monday); }
    .badge.low { background: rgba(255,100,100,0.2); color: #ff6b6b; }
    .badge.done { background: rgba(34,197,94,0.25); color: #22c55e; }
    .badge.pending { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.4); }

    .expandable { cursor: pointer; max-width: 250px; }
    .expandable-text { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5; transition: all 0.3s; }
    .expandable-text.expanded { -webkit-line-clamp: unset; display: block; }
    .expand-hint { color: var(--monday); font-size: 10px; margin-top: 4px; }

    .pagination { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; }
    .pagination button { padding: 10px 18px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; font-size: 13px; font-weight: 600; color: white; cursor: pointer; font-family: 'Inter', sans-serif; }
    .pagination button:hover:not(:disabled) { background: var(--monday); color: var(--storm); }
    .pagination button:disabled { opacity: 0.3; cursor: not-allowed; }
    .pagination span { font-size: 13px; color: rgba(255,255,255,0.6); }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--storm); border: 1px solid rgba(255,255,255,0.2); border-radius: 16px; padding: 28px; max-width: 480px; width: 95%; }
    .modal h3 { color: var(--monday); margin-bottom: 20px; font-size: 20px; }
    .modal label { display: block; margin-bottom: 8px; font-size: 13px; color: rgba(255,255,255,0.7); }
    .modal select, .modal textarea { width: 100%; margin-bottom: 16px; }
    .modal textarea { min-height: 80px; resize: vertical; padding: 12px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-family: 'Inter', sans-serif; font-size: 14px; }
    .modal-btns { display: flex; gap: 12px; justify-content: flex-end; }

    .loading { text-align: center; padding: 60px; color: rgba(255,255,255,0.5); }
    .spinner { width: 36px; height: 36px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--monday); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .actions-cell { white-space: nowrap; }
  </style>
</head>
<body>
  <div class="container">
    <nav class="nav">
      <a href="statistics.html">üìä Statistics</a>
      <a href="workspace.html" class="active">üìù Workspace</a>
    </nav>

    <div class="header">
      <h1>üìù Workspace</h1>
      <div class="header-right">
        <div class="live"><div class="live-dot"></div> Live</div>
        <button class="btn" onclick="refreshData()">‚Üª Refresh</button>
      </div>
    </div>

    <div class="filters">
      <div class="filter-group">
        <span class="filter-label">Domain</span>
        <select id="filter-domain" onchange="applyFilters()"><option value="">All</option></select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Relevance</span>
        <select id="filter-relevance" onchange="applyFilters()">
          <option value="">All</option>
          <option value="high">‚úÖ High</option>
          <option value="medium">‚òëÔ∏è Medium</option>
          <option value="low">‚ùå Low</option>
          <option value="null">Not Set</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Status</span>
        <select id="filter-done" onchange="applyFilters()">
          <option value="">All</option>
          <option value="done">‚úì Done</option>
          <option value="pending">‚óã Pending</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">From</span>
        <input type="date" id="filter-from" onchange="applyFilters()">
      </div>
      <div class="filter-group">
        <span class="filter-label">To</span>
        <input type="date" id="filter-to" onchange="applyFilters()">
      </div>
      <div class="quick-btns">
        <button class="quick-btn" onclick="quickFilter('3h')">Last 3h</button>
        <button class="quick-btn" onclick="quickFilter('24h')">Last 24h</button>
        <button class="quick-btn" onclick="quickFilter('7d')">Last 7d</button>
        <button class="quick-btn" onclick="quickFilter('high')">High Only</button>
        <button class="quick-btn" onclick="quickFilter('drafts')">With Drafts</button>
        <button class="quick-btn" onclick="quickFilter('clear')">Clear</button>
      </div>
    </div>

    <div class="table-info">
      <span id="table-info">Loading...</span>
      <span id="last-update"></span>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Domain</th>
            <th>Title</th>
            <th>Description</th>
            <th>Source URL</th>
            <th>Draft EN</th>
            <th>Draft AR</th>
            <th>Region</th>
            <th>Relevance</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr><td colspan="11" class="loading"><div class="spinner"></div>Loading articles...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="pagination">
      <button id="prev-btn" onclick="prevPage()" disabled>‚Üê Previous</button>
      <span id="page-info">Page 1</span>
      <button id="next-btn" onclick="nextPage()">Next ‚Üí</button>
    </div>
  </div>

  <div class="modal-overlay" id="modal">
    <div class="modal">
      <h3>‚öë Report Wrong Relevance</h3>
      <input type="hidden" id="modal-id">
      <label>Current: <strong id="modal-current"></strong></label>
      <label style="margin-top:12px">Correct Relevance:</label>
      <select id="modal-relevance">
        <option value="‚úÖ high">‚úÖ High</option>
        <option value="‚òëÔ∏è medium">‚òëÔ∏è Medium</option>
        <option value="‚ùå low">‚ùå Low</option>
      </select>
      <label>Reason:</label>
      <textarea id="modal-reason" placeholder="Why is this relevance incorrect?"></textarea>
      <div class="modal-btns">
        <button class="btn" style="background:transparent;border:1px solid var(--monday);color:var(--monday)" onclick="closeModal()">Cancel</button>
        <button class="btn" onclick="submitFeedback()">Submit</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://kwftlkfvtglnugxsyjci.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3ZnRsa2Z2dGdsbnVneHN5amNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2NDAxODUsImV4cCI6MjA2MzIxNjE4NX0.9Cn1xahmF8q6pbbWQHNyQSc9fZkVvJaqTzMRZCtmb9E';

    let page = 1, pageSize = 30;
    let filters = { domain: '', relevance: '', done: '', from: '', to: '', quick: '' };

    async function api(endpoint, opts = {}) {
      const params = new URLSearchParams();
      if (opts.select) params.append('select', opts.select);
      if (opts.order) params.append('order', opts.order);
      if (opts.limit) params.append('limit', opts.limit);
      if (opts.offset) params.append('offset', opts.offset);
      if (opts.filters) opts.filters.forEach(f => params.append(f.k, f.v));
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}?${params}`, {
        method: opts.method || 'GET',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': opts.count ? 'count=exact' : opts.prefer || ''
        },
        body: opts.body ? JSON.stringify(opts.body) : undefined
      });
      const count = res.headers.get('content-range')?.split('/')[1];
      const data = await res.json();
      return { data, count: count ? +count : null, ok: res.ok };
    }

    const fmt = n => n?.toLocaleString() || '0';
    const fmtDate = d => d ? new Date(d).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : '-';

    function buildFilters() {
      const f = [];
      if (filters.domain) f.push({ k: 'domain', v: `eq.${filters.domain}` });
      if (filters.relevance === 'high') f.push({ k: 'relevance', v: 'like.*high*' });
      else if (filters.relevance === 'medium') f.push({ k: 'relevance', v: 'like.*medium*' });
      else if (filters.relevance === 'low') f.push({ k: 'relevance', v: 'like.*low*' });
      else if (filters.relevance === 'null') f.push({ k: 'relevance', v: 'is.null' });
      if (filters.done === 'done') f.push({ k: 'done', v: 'neq.' });
      else if (filters.done === 'pending') f.push({ k: 'done', v: 'is.null' });
      if (filters.from) f.push({ k: 'uploaded_at', v: `gte.${filters.from}T00:00:00` });
      if (filters.to) f.push({ k: 'uploaded_at', v: `lte.${filters.to}T23:59:59` });
      if (filters.quick === 'drafts') f.push({ k: 'eng_blog_url', v: 'neq.' });
      return f;
    }

    function applyFilters() {
      filters.domain = document.getElementById('filter-domain').value;
      filters.relevance = document.getElementById('filter-relevance').value;
      filters.done = document.getElementById('filter-done').value;
      filters.from = document.getElementById('filter-from').value;
      filters.to = document.getElementById('filter-to').value;
      page = 1;
      loadTable();
    }

    function quickFilter(type) {
      document.querySelectorAll('.quick-btn').forEach(b => b.classList.remove('active'));
      if (type === 'clear') {
        filters = { domain: '', relevance: '', done: '', from: '', to: '', quick: '' };
        ['filter-domain', 'filter-relevance', 'filter-done', 'filter-from', 'filter-to'].forEach(id => document.getElementById(id).value = '');
      } else {
        event.target.classList.add('active');
        const now = new Date();
        if (type === '3h') { filters.from = new Date(now - 3*3600000).toISOString().split('T')[0]; filters.to = now.toISOString().split('T')[0]; }
        else if (type === '24h') { filters.from = new Date(now - 24*3600000).toISOString().split('T')[0]; filters.to = now.toISOString().split('T')[0]; }
        else if (type === '7d') { filters.from = new Date(now - 7*24*3600000).toISOString().split('T')[0]; filters.to = now.toISOString().split('T')[0]; }
        else if (type === 'high') { filters.relevance = 'high'; document.getElementById('filter-relevance').value = 'high'; }
        else if (type === 'drafts') { filters.quick = 'drafts'; }
      }
      page = 1;
      loadTable();
    }

    async function loadDomains() {
      const { data } = await api('incoming_links', { select: 'domain', limit: 70000 });
      const domains = [...new Set(data.map(d => d.domain).filter(Boolean))].sort();
      document.getElementById('filter-domain').innerHTML = '<option value="">All</option>' + domains.map(d => `<option value="${d}">${d}</option>`).join('');
    }

    async function loadTable() {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '<tr><td colspan="11" class="loading"><div class="spinner"></div>Loading...</td></tr>';

      const offset = (page - 1) * pageSize;
      const { data, count } = await api('incoming_links', {
        select: 'id,domain,url,title,description,region,relevance,done,uploaded_at,eng_blog_url,ar_blog_url',
        order: 'uploaded_at.desc',
        limit: pageSize,
        offset,
        count: true,
        filters: buildFilters()
      });

      const totalPages = Math.ceil((count || 0) / pageSize);
      document.getElementById('table-info').textContent = `Showing ${offset + 1}-${Math.min(offset + pageSize, count || 0)} of ${fmt(count)} articles`;
      document.getElementById('page-info').textContent = `Page ${page} / ${totalPages || 1}`;
      document.getElementById('prev-btn').disabled = page === 1;
      document.getElementById('next-btn').disabled = page >= totalPages;

      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:50px;color:rgba(255,255,255,0.4);">No articles found</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(r => `
        <tr class="${r.done ? 'done-row' : ''}">
          <td class="domain-cell">${r.domain || '-'}</td>
          <td class="expandable" onclick="toggleText(this)">
            <div class="expandable-text">${r.title || '-'}</div>
            ${r.title?.length > 60 ? '<div class="expand-hint">click to expand</div>' : ''}
          </td>
          <td class="expandable" onclick="toggleText(this)">
            <div class="expandable-text">${r.description || '-'}</div>
            ${r.description?.length > 80 ? '<div class="expand-hint">click to expand</div>' : ''}
          </td>
          <td><a href="${r.url}" target="_blank" class="url-link" title="${r.url}">${r.url?.substring(0, 40) || '-'}...</a></td>
          <td>
            ${r.eng_blog_url
              ? `<a href="${r.eng_blog_url}" target="_blank" class="draft-link">üìÑ Draft EN</a>`
              : '<span class="no-draft">‚Äî</span>'}
          </td>
          <td>
            ${r.ar_blog_url
              ? `<a href="${r.ar_blog_url}" target="_blank" class="draft-link ar">üìÑ Draft AR</a>`
              : '<span class="no-draft">‚Äî</span>'}
          </td>
          <td>${r.region || '-'}</td>
          <td>${getBadge(r.relevance)}</td>
          <td><span class="badge ${r.done ? 'done' : 'pending'}">${r.done ? '‚úì Done' : '‚óã Pending'}</span></td>
          <td style="white-space:nowrap;font-size:11px;color:rgba(255,255,255,0.6)">${fmtDate(r.uploaded_at)}</td>
          <td class="actions-cell">
            <button class="btn btn-small btn-done ${r.done ? 'active' : ''}" onclick="toggleDone('${r.id}', ${!r.done})" title="Mark as done">${r.done ? '‚úì' : '‚óã'}</button>
            <button class="btn btn-small btn-flag" onclick="openModal('${r.id}', '${r.relevance || ''}')" title="Report wrong relevance">‚öë</button>
          </td>
        </tr>
      `).join('');

      document.getElementById('last-update').textContent = 'Updated: ' + new Date().toLocaleTimeString();
    }

    function getBadge(r) {
      if (!r) return '<span class="badge pending">‚Äî</span>';
      if (r.includes('high')) return '<span class="badge high">High</span>';
      if (r.includes('medium')) return '<span class="badge medium">Medium</span>';
      return '<span class="badge low">Low</span>';
    }

    function toggleText(el) {
      const text = el.querySelector('.expandable-text');
      const hint = el.querySelector('.expand-hint');
      if (text) {
        text.classList.toggle('expanded');
        if (hint) hint.textContent = text.classList.contains('expanded') ? 'click to collapse' : 'click to expand';
      }
    }

    async function toggleDone(id, newState) {
      await api(`incoming_links?id=eq.${id}`, { method: 'PATCH', body: { done: newState ? 'done' : null }, prefer: 'return=minimal' });
      loadTable();
    }

    function openModal(id, current) {
      document.getElementById('modal-id').value = id;
      document.getElementById('modal-current').textContent = current || 'Not Set';
      document.getElementById('modal-reason').value = '';
      document.getElementById('modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
    }

    async function submitFeedback() {
      const { ok } = await api('relevance_feedback', {
        method: 'POST',
        body: {
          link_id: document.getElementById('modal-id').value,
          original_relevance: document.getElementById('modal-current').textContent,
          suggested_relevance: document.getElementById('modal-relevance').value,
          reason: document.getElementById('modal-reason').value
        },
        prefer: 'return=minimal'
      });
      if (ok) { closeModal(); alert('Feedback submitted!'); }
      else { alert('Error submitting feedback'); }
    }

    function prevPage() { if (page > 1) { page--; loadTable(); } }
    function nextPage() { page++; loadTable(); }

    async function refreshData() {
      await loadTable();
    }

    // Init
    loadDomains();
    loadTable();
    setInterval(loadTable, 120000);
  </script>
</body>
</html>
