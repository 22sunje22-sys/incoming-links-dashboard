<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workspace - Incoming Links</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --storm: #0A181C; --monday: #79E2FF; --day: #C7F8BA; --suede: #00A5D3; --electro: #221327; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--storm); min-height: 100vh; color: white; }
    .container { max-width: 1800px; margin: 0 auto; padding: 20px; }

    .nav { display: flex; gap: 12px; margin-bottom: 24px; }
    .nav a { padding: 12px 24px; background: rgba(255,255,255,0.1); border-radius: 8px; color: white; text-decoration: none; font-weight: 600; font-size: 14px; transition: all 0.2s; }
    .nav a:hover { background: rgba(255,255,255,0.2); }
    .nav a.active { background: var(--monday); color: var(--storm); }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px; }
    .header h1 { font-size: 28px; font-weight: 800; color: var(--monday); }
    .header-right { display: flex; align-items: center; gap: 16px; }
    .live { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--day); }
    .live-dot { width: 8px; height: 8px; background: var(--day); border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    .btn { padding: 10px 18px; background: var(--suede); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s; }
    .btn:hover { background: var(--monday); color: var(--storm); }

    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 12px; width: fit-content; }
    .tab { padding: 12px 24px; background: transparent; border: none; border-radius: 8px; color: rgba(255,255,255,0.6); font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
    .tab:hover { color: white; background: rgba(255,255,255,0.1); }
    .tab.active { background: var(--monday); color: var(--storm); }
    .tab-count { padding: 2px 8px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 12px; }
    .tab.active .tab-count { background: rgba(0,0,0,0.15); }

    .filters { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-label { font-size: 10px; color: rgba(255,255,255,0.5); text-transform: uppercase; font-weight: 600; }
    select, input[type="date"] { padding: 8px 12px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: white; font-size: 13px; font-family: 'Inter', sans-serif; }
    select:focus, input:focus { outline: none; border-color: var(--monday); }
    option { background: var(--storm); }

    .quick-btns { display: flex; gap: 6px; flex-wrap: wrap; }
    .quick-btn { padding: 8px 14px; background: rgba(255,255,255,0.08); border: none; border-radius: 20px; font-size: 12px; color: white; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s; }
    .quick-btn:hover, .quick-btn.active { background: var(--monday); color: var(--storm); }

    .table-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 13px; color: rgba(255,255,255,0.6); }

    .table-wrapper { overflow-x: auto; background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); }
    table { width: 100%; border-collapse: collapse; }
    thead { background: rgba(0,0,0,0.4); position: sticky; top: 0; }
    th { padding: 14px 12px; text-align: left; font-size: 10px; font-weight: 700; color: var(--monday); text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; border-bottom: 2px solid var(--monday); }
    td { padding: 14px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; vertical-align: top; }
    tr:hover { background: rgba(121,226,255,0.03); }

    .domain { color: var(--monday); font-weight: 600; font-size: 12px; }
    .title-cell { max-width: 200px; }
    .title-text { font-weight: 500; color: white; cursor: pointer; }
    .title-text:hover { color: var(--monday); }
    .desc-cell { max-width: 220px; }
    .desc-text { color: rgba(255,255,255,0.6); font-size: 12px; cursor: pointer; }
    .expand-hint { font-size: 10px; color: var(--suede); margin-top: 4px; }
    .expanded { white-space: normal !important; }
    .truncate { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    .source-link { color: var(--suede); text-decoration: none; font-size: 12px; word-break: break-all; }
    .source-link:hover { color: var(--monday); text-decoration: underline; }

    .draft-link { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--day); color: var(--storm); border-radius: 6px; text-decoration: none; font-size: 11px; font-weight: 700; transition: all 0.2s; }
    .draft-link:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(199,248,186,0.3); }
    .draft-link.ar { background: var(--monday); }
    .no-draft { color: rgba(255,255,255,0.2); font-size: 12px; }

    .region { font-size: 12px; }
    .relevance { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .relevance.high { background: rgba(199,248,186,0.2); color: var(--day); }
    .relevance.medium { background: rgba(0,165,211,0.2); color: var(--suede); }
    .relevance.low { background: rgba(255,107,107,0.2); color: #ff6b6b; }

    .status { font-size: 12px; padding: 4px 10px; border-radius: 12px; }
    .status.pending { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); }
    .status.done { background: rgba(199,248,186,0.2); color: var(--day); }

    .date { font-size: 12px; color: rgba(255,255,255,0.5); white-space: nowrap; }

    /* Action buttons */
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .action-btn { padding: 8px 14px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
    .action-btn.done-btn { background: rgba(199,248,186,0.15); color: var(--day); border: 1px solid rgba(199,248,186,0.3); }
    .action-btn.done-btn:hover { background: var(--day); color: var(--storm); }
    .action-btn.done-btn.active { background: var(--day); color: var(--storm); }
    .action-btn.flag-btn { background: rgba(255,107,107,0.15); color: #ff6b6b; border: 1px solid rgba(255,107,107,0.3); }
    .action-btn.flag-btn:hover { background: #ff6b6b; color: white; }
    .action-btn.flag-btn.active { background: #ff6b6b; color: white; }

    .pagination { display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 24px; padding: 20px; }
    .page-btn { padding: 10px 18px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; color: white; font-size: 13px; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s; }
    .page-btn:hover:not(:disabled) { background: var(--monday); color: var(--storm); }
    .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .page-info { font-size: 14px; color: rgba(255,255,255,0.6); }

    /* Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--storm); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; }
    .modal h2 { color: var(--monday); margin-bottom: 20px; font-size: 20px; }
    .modal label { display: block; margin-bottom: 8px; font-size: 13px; color: rgba(255,255,255,0.7); }
    .modal select, .modal textarea { width: 100%; padding: 12px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-size: 14px; font-family: 'Inter', sans-serif; margin-bottom: 16px; }
    .modal textarea { min-height: 100px; resize: vertical; }
    .modal-buttons { display: flex; gap: 12px; justify-content: flex-end; }
    .modal-btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; }
    .modal-btn.cancel { background: rgba(255,255,255,0.1); color: white; }
    .modal-btn.submit { background: var(--monday); color: var(--storm); }

    .footer { text-align: center; padding: 24px; font-size: 12px; color: rgba(255,255,255,0.3); }
  </style>
</head>
<body>
  <div class="container">
    <nav class="nav">
      <a href="statistics.html">üìä Statistics</a>
      <a href="workspace.html" class="active">üìù Workspace</a>
    </nav>

    <div class="header">
      <h1>üìù Workspace</h1>
      <div class="header-right">
        <div class="live"><div class="live-dot"></div> Live</div>
        <button class="btn" onclick="loadData()">‚Üª Refresh</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="all" onclick="switchTab('all')">
        üìã All <span class="tab-count" id="count-all">-</span>
      </button>
      <button class="tab" data-tab="done" onclick="switchTab('done')">
        ‚úÖ Done <span class="tab-count" id="count-done">-</span>
      </button>
      <button class="tab" data-tab="flagged" onclick="switchTab('flagged')">
        üö© Flagged <span class="tab-count" id="count-flagged">-</span>
      </button>
    </div>

    <div class="filters">
      <div class="filter-group">
        <span class="filter-label">Relevance</span>
        <select id="filter-relevance">
          <option value="">All</option>
          <option value="high">‚úÖ High</option>
          <option value="medium">‚òëÔ∏è Medium</option>
          <option value="low">‚ùå Low</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">From</span>
        <input type="date" id="filter-from">
      </div>
      <div class="filter-group">
        <span class="filter-label">To</span>
        <input type="date" id="filter-to">
      </div>
      <div class="quick-btns">
        <button class="quick-btn" onclick="quickFilter('3h')">Last 3h</button>
        <button class="quick-btn" onclick="quickFilter('24h')">Last 24h</button>
        <button class="quick-btn" onclick="quickFilter('7d')">Last 7d</button>
        <button class="quick-btn" onclick="quickFilter('high')">High Only</button>
        <button class="quick-btn" onclick="clearFilters()">Clear</button>
      </div>
    </div>

    <div class="table-info">
      <span id="showing">Loading...</span>
      <span>Updated: <span id="updated-time">-</span></span>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Domain</th>
            <th>Title</th>
            <th>Description</th>
            <th>Source URL</th>
            <th>Draft EN</th>
            <th>Draft AR</th>
            <th>Region</th>
            <th>Relevance</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>

    <div class="pagination">
      <button class="page-btn" id="prev-btn" onclick="changePage(-1)">‚Üê Previous</button>
      <span class="page-info" id="page-info">Page 1</span>
      <button class="page-btn" id="next-btn" onclick="changePage(1)">Next ‚Üí</button>
    </div>

    <div class="footer">Incoming Links Dashboard ‚Ä¢ Auto-refresh every 2 min</div>
  </div>

  <!-- Flag Modal -->
  <div class="modal-overlay" id="flag-modal">
    <div class="modal">
      <h2>üö© Report Wrong Relevance</h2>
      <label>What should be the correct relevance?</label>
      <select id="flag-relevance">
        <option value="high">‚úÖ High - Very relevant</option>
        <option value="medium">‚òëÔ∏è Medium - Somewhat relevant</option>
        <option value="low">‚ùå Low - Not relevant</option>
      </select>
      <label>Reason (optional)</label>
      <textarea id="flag-reason" placeholder="Explain why the relevance should be changed..."></textarea>
      <div class="modal-buttons">
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-btn submit" onclick="submitFlag()">Submit Report</button>
      </div>
    </div>
  </div>

  <script>
    // NO SUPABASE KEY EXPOSED - All calls go through secure API proxy
    const API_BASE = '/api';

    let currentPage = 1;
    let totalCount = 0;
    let currentTab = 'all';
    let flaggingId = null;
    let flaggedIds = new Set();
    const perPage = 30;

    // Fetch count from secure API
    async function fetchCount(type) {
      const response = await fetch(`${API_BASE}/stats?type=${type}`);
      const data = await response.json();
      return data.count || 0;
    }

    // Fetch links from secure API
    async function fetchLinks(options = {}) {
      const params = new URLSearchParams(options);
      const response = await fetch(`${API_BASE}/links?${params}`);
      return response.json();
    }

    // Mark as done through secure API
    async function markDone(id) {
      const response = await fetch(`${API_BASE}/mark-done`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      });
      return response.json();
    }

    // Flag issue through secure API
    async function flagIssue(data) {
      const response = await fetch(`${API_BASE}/flag-issue`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      return response.json();
    }

    async function loadCounts() {
      const [allCount, doneCount, flaggedCount] = await Promise.all([
        fetchCount('pending'),
        fetchCount('done'),
        fetchCount('flagged')
      ]);
      document.getElementById('count-all').textContent = allCount.toLocaleString();
      document.getElementById('count-done').textContent = doneCount.toLocaleString();
      document.getElementById('count-flagged').textContent = flaggedCount.toLocaleString();
    }

    function switchTab(tab) {
      currentTab = tab;
      currentPage = 1;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      loadData();
    }

    async function loadData() {
      await loadCounts();

      const relevance = document.getElementById('filter-relevance').value;
      const from = document.getElementById('filter-from').value;
      const to = document.getElementById('filter-to').value;

      const params = {
        tab: currentTab,
        page: currentPage - 1,
        limit: perPage
      };

      if (relevance) params.relevance = relevance;
      if (from) params.dateFrom = from;
      if (to) params.dateTo = to;

      const result = await fetchLinks(params);
      const data = result.data || [];
      totalCount = result.total || 0;

      renderTable(data);
      updatePagination();
      document.getElementById('updated-time').textContent = new Date().toLocaleTimeString();
    }

    function renderTable(data) {
      const tbody = document.getElementById('table-body');

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5);">No items found</td></tr>';
        document.getElementById('showing').textContent = 'No items';
        return;
      }

      document.getElementById('showing').textContent = `Showing ${(currentPage-1)*perPage + 1}-${Math.min(currentPage*perPage, totalCount)} of ${totalCount.toLocaleString()} articles`;

      tbody.innerHTML = data.map(r => {
        const relClass = r.relevance?.includes('high') ? 'high' : r.relevance?.includes('medium') ? 'medium' : r.relevance?.includes('low') ? 'low' : '';
        const relText = r.relevance?.includes('high') ? 'High' : r.relevance?.includes('medium') ? 'Medium' : r.relevance?.includes('low') ? 'Low' : '-';
        const isDone = r.done && r.done.trim() !== '';
        const isFlagged = r.flagged === true;
        const date = r.uploaded_at ? new Date(r.uploaded_at).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : '-';

        return `<tr>
          <td><span class="domain">${r.domain || '-'}</span></td>
          <td class="title-cell">
            <div class="title-text truncate" onclick="toggleExpand(this)">${r.title || '-'}</div>
            ${r.title ? '<div class="expand-hint">click to expand</div>' : ''}
          </td>
          <td class="desc-cell">
            <div class="desc-text truncate" onclick="toggleExpand(this)">${r.short_description || r.long_description || '-'}</div>
          </td>
        <td>${r.url ? `<a href="${r.url}" target="_blank" class="source-link" title="${r.url}">üîó</a>` : '-'}</td>          <td>${r.eng_blog_url ? `<a href="${r.eng_blog_url}" target="_blank" class="draft-link">üìÑ Draft EN</a>` : '<span class="no-draft">‚Äî</span>'}</td>
          <td>${r.ar_blog_url ? `<a href="${r.ar_blog_url}" target="_blank" class="draft-link ar">üìÑ Draft AR</a>` : '<span class="no-draft">‚Äî</span>'}</td>
          <td class="region">${r.region || '-'} ${r.region_emoji || ''}</td>
          <td>${relClass ? `<span class="relevance ${relClass}">${relText}</span>` : '-'}</td>
          <td><span class="status ${isDone ? 'done' : 'pending'}">${isDone ? '‚úì Done' : '‚óã Pending'}</span></td>
          <td class="date">${date}</td>
          <td class="actions">
            <button class="action-btn done-btn ${isDone ? 'active' : ''}" onclick="toggleDone('${r.id}', ${isDone})" title="Mark as done">
              ${isDone ? '‚úì Done' : '‚òê Mark Done'}
            </button>
            <button class="action-btn flag-btn ${isFlagged ? 'active' : ''}" onclick="openFlagModal('${r.id}', '${r.relevance || ''}')" title="Report issue">
              ${isFlagged ? 'üö© Flagged' : '‚öë Flag Issue'}
            </button>
          </td>
        </tr>`;
      }).join('');
    }

    function toggleExpand(el) {
      el.classList.toggle('truncate');
      el.classList.toggle('expanded');
    }

    async function toggleDone(id, currentlyDone) {
      if (!currentlyDone) {
        await markDone(id);
      }
      loadData();
    }

    function openFlagModal(id, currentRelevance) {
      flaggingId = id;
      document.getElementById('flag-modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('flag-modal').classList.remove('show');
      flaggingId = null;
    }

    async function submitFlag() {
      if (!flaggingId) return;
      const suggested = document.getElementById('flag-relevance').value;
      const reason = document.getElementById('flag-reason').value;

      await flagIssue({
        link_id: flaggingId,
        issue_type: 'wrong_relevance',
        correct_relevance: suggested,
        notes: reason
      });

      closeModal();
      document.getElementById('flag-reason').value = '';
      loadData();
    }

    function quickFilter(type) {
      clearFilters();
      const now = new Date();
      if (type === '3h') {
        const d = new Date(now - 3*60*60*1000);
        document.getElementById('filter-from').value = d.toISOString().split('T')[0];
      } else if (type === '24h') {
        const d = new Date(now - 24*60*60*1000);
        document.getElementById('filter-from').value = d.toISOString().split('T')[0];
      } else if (type === '7d') {
        const d = new Date(now - 7*24*60*60*1000);
        document.getElementById('filter-from').value = d.toISOString().split('T')[0];
      } else if (type === 'high') {
        document.getElementById('filter-relevance').value = 'high';
      }
      currentPage = 1;
      loadData();
    }

    function clearFilters() {
      document.getElementById('filter-relevance').value = '';
      document.getElementById('filter-from').value = '';
      document.getElementById('filter-to').value = '';
      currentPage = 1;
    }

    function changePage(dir) {
      currentPage += dir;
      loadData();
    }

    function updatePagination() {
      const totalPages = Math.ceil(totalCount / perPage);
      document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages || 1}`;
      document.getElementById('prev-btn').disabled = currentPage <= 1;
      document.getElementById('next-btn').disabled = currentPage >= totalPages;
    }

    // Event listeners for filters
    ['filter-relevance', 'filter-from', 'filter-to'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => { currentPage = 1; loadData(); });
    });

    // Initialize
    loadData();
    setInterval(loadData, 120000);
  </script>
</body>
</html>
